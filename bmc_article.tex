%% BioMed_Central_Tex_Template_v1.06
%%                                      %
%  bmc_article.tex            ver: 1.06 %
%                                       %

%%IMPORTANT: do not delete the first line of this template
%%It must be present to enable the BMC Submission system to
%%recognise this template!!

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                                     %%
%%  LaTeX template for BioMed Central  %%
%%     journal article submissions     %%
%%                                     %%
%%          <8 June 2012>              %%
%%                                     %%
%%                                     %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                                                                 %%
%% For instructions on how to fill out this Tex template           %%
%% document please refer to Readme.html and the instructions for   %%
%% authors page on the biomed central website                      %%
%% http://www.biomedcentral.com/info/authors/                      %%
%%                                                                 %%
%% Please do not use \input{...} to include other tex files.       %%
%% Submit your LaTeX manuscript as one .tex document.              %%
%%                                                                 %%
%% All additional figures and files should be attached             %%
%% separately and not embedded in the \TeX\ document itself.       %%
%%                                                                 %%
%% BioMed Central currently use the MikTex distribution of         %%
%% TeX for Windows) of TeX and LaTeX.  This is available from      %%
%% http://www.miktex.org                                           %%
%%                                                                 %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%% additional documentclass options:
%  [doublespacing]
%  [linenumbers]   - put the line numbers on margins

%%% loading packages, author definitions

\documentclass[twocolumn]{bmcart}% uncomment this for twocolumn layout and comment line below
% \documentclass{bmcart}

%%% Load packages
\usepackage{amsthm,amsmath}
\RequirePackage{natbib}
%\RequirePackage[authoryear]{natbib}% uncomment this for author-year bibliography
\RequirePackage{hyperref}
\usepackage[utf8]{inputenc} %unicode support
%\usepackage[applemac]{inputenc} %applemac support if unicode package fails
%\usepackage[latin1]{inputenc} %UNIX support if unicode package fails
\usepackage{lineno} % for line numbers
\usepackage{textcomp} % for single quotes
% orcid code from https://tex.stackexchange.com/questions/445563/ieeetran-how-to-include-orcid-in-tex-pdf-with-pdflatex/445583#445583
\usepackage{scalerel}
\usepackage{tikz}
\usetikzlibrary{svg.path}

\definecolor{orcidlogocol}{HTML}{A6CE39}
\tikzset{
    orcidlogo/.pic={
        \fill[orcidlogocol] svg{M256,128c0,70.7-57.3,128-128,128C57.3,256,0,198.7,0,128C0,57.3,57.3,0,128,0C198.7,0,256,57.3,256,128z};
        \fill[white] svg{M86.3,186.2H70.9V79.1h15.4v48.4V186.2z}
        svg{M108.9,79.1h41.6c39.6,0,57,28.3,57,53.6c0,27.5-21.5,53.6-56.8,53.6h-41.8V79.1z M124.3,172.4h24.5c34.9,0,42.9-26.5,42.9-39.7c0-21.5-13.7-39.7-43.7-39.7h-23.7V172.4z}
        svg{M88.7,56.8c0,5.5-4.5,10.1-10.1,10.1c-5.6,0-10.1-4.6-10.1-10.1c0-5.6,4.5-10.1,10.1-10.1C84.2,46.7,88.7,51.3,88.7,56.8z};
    }
}

\newcommand\orcidicon[1]{\href{https://orcid.org/#1}{\mbox{\scalerel*{
                \begin{tikzpicture}[yscale=-1,transform shape]
                \pic{orcidlogo};
                \end{tikzpicture}
            }{|}}}}
\usepackage{tcolorbox}
\usepackage{lineno}
\usepackage{textcomp}
\usepackage{enumitem}
\usepackage{graphicx}
\graphicspath{ {./images/} }
\usepackage{minted}
\usepackage{hyperref} %<--- Load after everything else

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                                             %%
%%  If you wish to display your graphics for   %%
%%  your own use using includegraphic or       %%
%%  includegraphics, then comment out the      %%
%%  following two lines of code.               %%
%%  NB: These line *must* be included when     %%
%%  submitting to BMC.                         %%
%%  All figure files must be submitted as      %%
%%  separate graphics through the BMC          %%
%%  submission process, not included in the    %%
%%  submitted article.                         %%
%%                                             %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% uncomment these to remove figures
\def\includegraphic{}
\def\includegraphics{}

\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}

%%% Put your definitions there:
\startlocaldefs
\usepackage{url}
\endlocaldefs

 \newenvironment{handson_box}
    {\begin{center}
    
    \begin{tabular}{|p{0.9\textwidth/2}|}
    \hline\\
    }
    { 
    \\\\\hline
    \end{tabular} 
    \end{center}
    }    

\newcounter{handsoncounter}
\newtcolorbox[use counter=handsoncounter,number format=\arabic]{handson_box_colour}[2][]{boxrule=0.3mm,colback=gray!5!white,colframe=bmcblue, arc=0mm, title=Hands-on \thetcbcounter: #2,#1}
%\newtcolorbox{handson_box_colour}{boxrule=0.3mm,colback=gray!5!white,colframe=bmcblue, arc=0mm}


%%% Begin ...
\begin{document}

%%% Start of article front matter
\begin{frontmatter}

\begin{fmbox}
\dochead{Educational}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                                          %%
%% Enter the title of your article here     %%
%%                                          %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\title{Intuitive, reproducible high-throughput molecular dynamics in Galaxy: a tutorial}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                                          %%
%% Enter the authors here                   %%
%%                                          %%
%% Specify information, if available,       %%
%% in the form:                             %%
%%   <key>={<id1>,<id2>}                    %%
%%   <key>=                                 %%
%% Comment or delete the keys which are     %%
%% not used. Repeat \author command as much %%
%% as required.                             %%
%%                                          %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\author[ addressref={aff1},                   % id's of addresses, e.g. {aff1,aff2}
   %noteref={n1},                        % id's of article notes, if any
   email={sbray1371@gmail.com}   % email address
]{\inits{SAB}\fnm{Simon A.} \snm{Bray}} \orcidicon{0000-0002-0621-6705}
\author[
   addressref={aff2},
   %noteref={n1},
   email={}
]{\inits{TS}\fnm{Tharindu} \snm{Senapathi}} \orcidicon{0000-0002-3277-4022}
\author[
   addressref={aff2},
   email={chris.barnett@uct.ac.za}
]{\inits{CBB}\fnm{Christopher B.} \snm{Barnett}} \orcidicon{0000-0002-1467-5741}
\author[
   addressref={aff1},
   corref={aff1,aff2},
   email={gruening@informatik.uni-freiburg.de; chris.barnett@uct.ac.za}
]{\inits{BAG}\fnm{Björn A.} \snm{Grüning}} \orcidicon{0000-0002-3079-6586}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                                          %%
%% Enter the authors' addresses here        %%
%%                                          %%
%% Repeat \address commands as much as      %%
%% required.                                %%
%%                                          %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\address[id=aff1]{%                           % unique id
   \orgname{Department of Computer Science, University of Freiburg}, % university, etc
   \street{Georges-Köhler-Allee 106},                     %
  %\postcode{}                                % post or zip code
   \city{Freiburg},                              % city
   \cny{Germany}                                    % country
}
\address[id=aff2]{%
  \orgname{Scientific Computing Research Unit, University of Cape Town},
  \postcode{7700}
  \city{Cape Town},
  \cny{South Africa}
}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                                          %%
%% Enter short notes here                   %%
%%                                          %%
%% Short notes will be after addresses      %%
%% on first page.                           %%
%%                                          %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{artnotes}
%\note{Sample of title note}     % note to the article
\note[id=n1]{Equal contributor} % note, connected to author
\end{artnotes}

\end{fmbox}% comment this for two column layout

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                                          %%
%% The Abstract begins here                 %%
%%                                          %%
%% Please refer to the Instructions for     %%
%% authors on http://www.biomedcentral.com  %%
%% and include the section headings         %%
%% accordingly for your article type.       %%
%%                                          %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{abstractbox}

\begin{abstract} % abstract
This paper is a tutorial developed for the data analysis platform Galaxy. The purpose of Galaxy is to make high-throughput computational data analysis, such as molecular dynamics, a structured, reproducible and transparent process. In this tutorial we
focus on 3 questions: How are protein-ligand systems parameterized for
molecular dynamics simulation? What kind of analysis can be carried out
on molecular trajectories? How can high-throughput MD be used to study
multiple ligands? After finishing you will have learned about
force-fields and MD parameterization, how to conduct MD simulation
and analysis for a protein-ligand system, and understand how different
molecular interactions contribute to the binding affinity of
ligands to the Hsp90 protein. 

\end{abstract}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                                          %%
%% The keywords begin here                  %%
%%                                          %%
%% Put each keyword in separate \kwd{}.     %%
%%                                          %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{keyword}
\kwd{Galaxy}
\kwd{Molecular Dynamics}
\kwd{Reproducible}
\end{keyword}

% MSC classifications codes, if any
%\begin{keyword}[class=AMS]
%\kwd[Primary ]{}
%\kwd{}
%\kwd[; secondary ]{}
%\end{keyword}

\end{abstractbox}
%
%\end{fmbox}% uncomment this for twcolumn layout

\end{frontmatter}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                                          %%
%% The Main Body begins here                %%
%%                                          %%
%% Please refer to the instructions for     %%
%% authors on:                              %%
%% http://www.biomedcentral.com/info/authors%%
%% and include the section headings         %%
%% accordingly for your article type.       %%
%%                                          %%
%% See the Results and Discussion section   %%
%% for details on how to create sub-sections%%
%%                                          %%
%% use \cite{...} to cite references        %%
%%  \cite{koon} and                         %%
%%  \cite{oreg,khar,zvai,xjon,schn,pond}    %%
%%  \nocite{smith,marg,hunn,advi,koha,mouse}%%
%%                                          %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%% start of article main body
% <put your article body there>

%%%%%%%%%%%%%%%%
%% Background %%
%%


%\linenumbers

\hypertarget{introduction}{%
\section*{Introduction}\label{introduction}}

Molecular dynamics (MD) is a commonly used method in computational chemistry and cheminformatics, in particular for studying the interactions between small molecules and large biological macromolecules such as proteins~\cite{berendsen01}. However, the barrier to entry for MD simulation is high; not only is the theory difficult to master, but commonly used MD software is technically demanding. Furthermore, generating reliable, reproducible simulation data requires the user to maintain detailed records of all parameters and files used, which again poses a challenge to newcomers to the field. One solution to the latter problem is usage of a workflow management system such as Galaxy~\cite{afgan_galaxy_2018}, which provides a selection of tools for molecular dynamics simulation and analysis~\cite{senapathi_biomolecular_2019}. MD simulations are rarely performed singly; in recent years, the concept of high-throughput molecular dynamics (HTMD) has come to the fore~\cite{HARVEY20121059,Guterres2020}. Galaxy lends itself well to this kind of study, as we will demonstrate in this paper, thanks to features allowing construction of complex workflows, which can then be executed on multiple inputs in parallel.

This tutorial provides a detailed workflow for high-throughput molecular dynamics with Galaxy, using the N-terminal domain (NTD) of Hsp90 (heat shock protein 90) as a case-study. Galaxy~\cite{afgan_galaxy_2018} is a data analysis platform that provides access to thousands of tools for scientific computation. It features a web-based user interface while automatically and transparently managing underlying computation details. Galaxy makes high-throughput data analysis a structured, reproducible and transparent process. This tutorial provides sample data, workflows, hands-on material and references for further reading. It presumes that the user has a basic understanding of the Galaxy platform. The aim is to guide the user through the various steps of a molecular dynamics study, from accessing publicly available crystal structures, to performing MD simulation (leveraging the popular GROMACS~\cite{abraham_gromacs_2015,Lemkul2019} engine), to analysis of the results.

The entire analysis described in this article can be conducted efficiently on any Galaxy server which has the needed tools. In particular, we recommend using the Galaxy Europe server
(\url{https://cheminformatics.usegalaxy.eu}) or the Galaxy South Africa server (\url{https://galaxy-compchem.ilifu.ac.za}).

The tutorial presented in this article has been developed as part of the Galaxy Training Network~\cite{Batut2018} and its most up-to-date version is accessible online on the Galaxy Training Materials website~\cite{gtn_comp}, under the URL \url{https://training.galaxyproject.org/training-material/topics/computational-chemistry/tutorials/htmd-analysis/tutorial.html}.

\subsection*{What is high-throughput molecular
dynamics?}\label{what-is-high-throughput-molecular-dynamics}

Molecular dynamics (MD) is a method to simulate molecular motion by
iterative application of Newton's laws of motion. It is often applied to
large biomolecules such as proteins or nucleic acids. A common
application is to assess the interaction between these macromolecules
and a number of small molecules (e.g.~potential drug candidates). This
tutorial provides a guide to setting up and running a high-throughput
workflow for screening multiple small molecules, using the open-source
GROMACS tools provided through the Galaxy platform. Following simulation, the trajectory data is analyzed using a range of tools to investigate structural properties and correlations over time.


\subsection*{Why is Hsp90 interesting to
study?}\label{why-is-hsp90-interesting-to-study}

The 90 kDa heat shock protein (Hsp90) is a chaperone protein responsible
for catalyzing the conversion of a wide variety of proteins to a
functional form; examples of the Hsp90 clientele, which totals several
hundred proteins, include nuclear steroid hormone receptors and protein
kinases~\cite{Pearl2006}. The mechanism by which Hsp90 acts varies between clients, as
does the client binding site; the process is dependent on
post-translational modifications of Hsp90 and the identity of
co-chaperones which bind and regulate the conformational cycle~\cite{Schopf2017}.

Due to its vital biochemical role as a chaperone protein involved in
facilitating the folding of many client proteins, Hsp90 is an attractive
pharmaceutical target. In particular, as protein folding is a potential
bottleneck to cellular reproduction and growth, blocking Hsp90
function using inhibitors which bind tightly to the ATP binding site of the NTD
could assist in treating cancer; for example, the antibiotic
geldanamycin and its analogs are under investigation as possible
anti-tumor agents~\cite{Stebbins1997,Hermane2019}.

In the structure which will be examined during this tutorial, the ligand of concern is a resorcinol, a common class of compounds with affinity for the Hsp90 N-terminal domain. It is registered in the PubChem database under the compound ID 135508238~\cite{ligand_resorcinol}. As can be seen by viewing the PDB structure, the resorcinol part of the structure is embedded in the binding site, bound by a hydrogen bond to residue aspartate-93. The ligand structure also contains a triazole and a fluorophenyl ring, which lie nearer to the surface of the protein.

\begin{figure}[ht!]
  %\includegraphics[width=0.4\textwidth]{hsp90lig}
    \caption{\csentence{Hsp90 cartoon view.}
    Hsp90 cartoon with ligands in active site, rendered using the Galaxy NGL plugin~\cite{Rose2018ngl}}
\label{fig:Hsp90}
 \end{figure}

\hypertarget{methods}{%
\section*{Methods: Simulation}\label{methods}}
In this section we will take the reader through the step-by-step process required to prepare, run and analyze Hsp90. A brief explanation of the theory and purpose of each step is provided. Refer to the hands-on sections as these describe the task with tools and parameters to be carried out using Galaxy. 

%\hypertarget{simulation}{%
%\subsection*{Simulation}\label{simulation}}

\subsection*{Get data}\label{get-data}

As a first step, we create a new Galaxy history and then we download a crystal structure for the Hsp90 protein from the Protein Data Bank (PDB). The structure is provided under accession code \texttt{6HHR}~\cite{Schuetz2018} and shows Hsp90 in complex with a ligand belonging to the resorcinol class.

\begin{handson_box_colour}{Data upload}
%\textbf{Hands-on: Data upload}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Create a new history for this tutorial
\item
  Search Galaxy for the \textbf{Get PDB} tool. Request the accession code \texttt{6HHR}.
\item
  Rename the dataset to `Hsp90 structure'

\end{enumerate}
\end{handson_box_colour}

\subsection*{Topology generation}\label{topology-generation}

Now we have downloaded a PDB structure of the protein we wish to study, we will start preparing it for MD simulation; this process may also be referred to as parameterization or topology generation.

GROMACS distinguishes between constant and dynamic attributes of the
atoms in the system. The constant attributes (e.g. atom charges, bonds
connecting atoms) are listed in the topology (TOP file), while dynamic
attributes (attributes that can change during a simulation, e.g. atom
position, velocities and forces) are stored in structure (PDB or GRO)
and trajectory (XTC and TRR) files.

The PDB file we start from only explicitly states atom element (i.e. carbon, oxygen, and so on) and
3D Cartesian coordinates of each atom; additionally, it will usually not include hydrogen atoms. Therefore, before beginning simulation, we need to calculate
the rest of the information contained within the topology file.

% perhaps some more discussion here and a citation of https://www.sciencedirect.com/science/article/pii/S1877117319302157

\subsection*{Extract protein and ligand
coordinates}\label{extract-protein-and-ligand-coordinates}

Parameterization needs to be done separately for the ligand and protein.
Therefore, the first step is to separate the PDB file into two sets of
coordinates - one for the ligand and one for the protein. Here, we can make use of the simple text manipulation tools integrated into Galaxy.

\begin{handson_box_colour}{Separate protein and ligand coordinates}
%\textbf{Hands-on: Separate protein and ligand coordinates}\label{hands-on-task-description}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \textbf{Search in textfiles} with the following parameters:
  \begin{itemize}
  \tightlist
  \item
    \emph{``Select lines from''}: `Hsp90 structure'
  \item
    \emph{``that''}: \texttt{Don\textquotesingle{}t\ Match}
  \item
    \emph{``Regular Expression''}: \texttt{HETATM}
  \end{itemize}
\item
  Rename output to `Protein (PDB)'
\item
  \textbf{Search in textfiles} with the following parameters:

  \begin{itemize}
  \tightlist
  \item
    \emph{``Select lines from''}: `Hsp90 structure'
  \item
    \emph{``that''}: \texttt{Match}
  \item
    \emph{``Regular Expression''}: \texttt{AG5E}
  \end{itemize}
\item
  Rename output to `Ligand (PDB)'
\end{enumerate}

\end{handson_box_colour}

Here, we simply filter the original PDB twice: once for lines which do not match \texttt{HETATM}, which returns a PDB file containing only protein, not ligand and solvent; and once for lines which match the ligand's identity code \texttt{AG5E}, which returns a PDB file containing only the ligand.

\hypertarget{set-up-protein-topology}{%
\subsection*{Set up protein topology}\label{set-up-protein-topology}}

Firstly, we need to calculate the topology for the protein file. We will
use the \textbf{GROMACS initial setup} tool.

\begin{handson_box_colour}{Generate protein topology}
%\textbf{Hands-on: Generate protein topology}\label{hands-on-task-description-1}

% \begin{enumerate}
% \def\labelenumi{\arabic{enumi}.}
% \tightlist
% \item
  \textbf{GROMACS initial setup} with the following parameters:

  \begin{itemize}
  \tightlist
  \item
    \emph{``PDB input file''}: `Protein (PDB)' file
  \item
    \emph{``Force field''}: \texttt{AMBER99SB}
  \item
    \emph{``Water model''}: \texttt{TIP3P}
  \item
    \emph{``Generate detailed log''}: \texttt{Yes}
  \end{itemize}
% \end{enumerate}
\end{handson_box_colour}

A force field is essentially a function to calculate the potential energy of a system, based on various empirical parameters (for the atoms, bonds, charges, dihedral angles and so on). There are a number of families of force fields; some of the most commonly used include CHARMM~\cite{Vanommeslaeghe2009}, AMBER~\cite{Maier2015}, GROMOS~\cite{reif2012} and OpenFF~\cite{Mobley2018} (for a recent, accessible overview see ~\cite{Lemkul2020}). We will use \texttt{ff99SB}, which is one of the main AMBER force fields for protein modeling.

Apart from the force field, a water model also needs to be selected to model the solvent; a wide range of models exist for this purpose. Here we are using the common TIP3P model, which is an example of a `three-site model' - so-called because the molecule is modeled using three points, corresponding to the three atoms of water (Four- and five-site models include additional `dummy atoms' representing the negative charges of the lone pairs of the oxygen atom)~\cite{Onufriev2017}.

The tool produces four outputs: a GRO file (containing the coordinates
of the protein), a TOP file (containing other information, including
charges, masses, bonds and angles), an ITP file (which will be used to
restrain the protein position in the equilibration step later on), and a
log for the tool.

Please note all the GROMACS tools provided in Galaxy output a log. These provide useful information for
debugging if we encounter any problems.

\subsection*{Generate a topology for the
ligand}\label{generate-a-topology-for-the-ligand}

To generate a topology for the ligand, we will use the \textbf{acpype}~\cite{SousadaSilva2012}
tool. This provides a convenient interface to the AmberTools suite and
allows us to easily create the ligand topology in the format required by
GROMACS.

\begin{handson_box_colour}{Generate ligand topology}
%\textbf{Hands-on: Generate ligand topology}\label{hands-on-task-description-2}

% \begin{enumerate}
% \def\labelenumi{\arabic{enumi}.}
% \tightlist
% \item
  \textbf{Generate MD topologies for small molecules} with the following
  parameters:

  \begin{itemize}
  \tightlist
  \item
    \emph{``Input file''}: `Ligand (PDB)'
  \item
    \emph{``Charge of the molecule''}: \texttt{0}
  \item
    \emph{``Multiplicity''}: \texttt{1}
  \item
    \emph{``Force field to use for parameterization''}:
    \texttt{gaff}
  \item
    \emph{``Save GRO file?''}: \texttt{Yes}
  \end{itemize}
% \end{enumerate}

\end{handson_box_colour}

Here, we use GAFF (general AMBER force field), which is a generalized AMBER force field~\cite{Wang2004} which can be applied to almost any small organic molecule.

We select charge and multiplicity as appropriate. The ligand studied here is neutral, so the charge is 0. The multiplicity is 1, which will be the case for every simple organic molecule we encounter; only if we deal with more exotic species such as metal complexes or carbenes will we need to consider higher values.

%\subsection*{Solvation and energy minimization}\label{solvation-and-energy-minimization}

Having generated topologies, we now need to combine them, define the box
which contains the system, add solvent and ions, and perform an energy
minimization step.

\subsection*{Combine topology and GRO
files}\label{combine-topology-and-gro-files}

While we have separate topology and structure files for both protein and ligand, we need to combine them into a single set of files to continue with the simulation setup. A dedicated Galaxy tool is provided for this, using the Python library ParmEd~\cite{Swails2016}.

\begin{handson_box_colour}{Combine GRO and topology files}
%\textbf{Hands-on: Combine GRO and topology files}\label{hands-on-task-description-2}

% \begin{enumerate}
% \def\labelenumi{\arabic{enumi}.}
% \tightlist
% \item
  \textbf{Merge GROMACS topologies} with the following
  parameters:

  \begin{itemize}
  \tightlist
  \item
    \emph{``Protein topology (TOP) file''}: \texttt{TOP} file created by the \textbf{GROMACS initial setup tool}
  \item
    \emph{``Ligand topology (TOP or ITP) file''}: \texttt{Topology} file created by the \textbf{acpype}
  \item
    \emph{``Protein structure (GRO) file''}: \texttt{GRO} file created by the \textbf{GROMACS initial setup tool}
  \item
    \emph{``Ligand structure (GRO) file''}: \texttt{Structure file (GRO format)} file created by the \textbf{acpype}

  \end{itemize}
% \end{enumerate}

\end{handson_box_colour}

We now have a single GRO and TOP file, unifying the protein-ligand complex structure and topology.

\subsection*{\texorpdfstring{Create the simulation box with
\textbf{GROMACS structure
configuration}}{Create the simulation box with GROMACS structure configuration}}\label{create-the-simulation-box-with-gromacs-structure-configuration}

The next step, once combined coordinate (GRO) and topology (TOP) files
have been created, is to create a simulation box in which the system is
situated.

\begin{handson_box_colour}{Create simulation box}

%\hypertarget{hands-on-task-description-3}{%
%\textbf{Hands-on: Create simulation box}\label{hands-on-task-description-3}}

% \begin{enumerate}
% \def\labelenumi{\arabic{enumi}.}
% %\tightlist
% \item
  \textbf{GROMACS structure configuration} with the following
  parameters:

  \begin{itemize}
%  \tightlist
  \item
    \emph{``Input structure''}: \texttt{System\ GRO\ file} (Input
    dataset)
  \item
    \emph{``Configure box?''}: \texttt{Yes}

    \begin{itemize}
%    \tightlist
    \item
      \emph{``Box dimensions in nanometers''}: \texttt{1.0}
    \item
      \emph{``Box type''}: \texttt{Triclinic}
    \end{itemize}
  \item
    \emph{``Generate detailed log''}: \texttt{Yes}
  \end{itemize}
% \end{enumerate}

\end{handson_box_colour}

This tool returns a new GRO structure file, containing the same coordinates as before, but defining a simulation box such that every atom is a minimum of 1 nm from the box boundary. A variety of box shapes are available to choose: we select triclinic, as it provides the most efficient packing in space and thus fewer computational resources need to be devoted to simulation of solvent. 

\subsection*{Solvation}\label{solvation}
The next step is solvation of the newly created simulation box - as we are simulating under biological conditions, we use water as the solvent. Note
that the system is charged (depending on the pH) - the solvation tool
also adds sodium or chloride ions (replacing existing water molecules) as required to neutralize this.

\begin{handson_box_colour}{Solvation}

%\textbf{Hands-on: Solvation}\label{hands-on-task-description-4}

% \begin{enumerate}
% \def\labelenumi{\arabic{enumi}.}
% \tightlist
% \item
  \textbf{GROMACS solvation and adding ions} with the following
  parameters:
  \begin{itemize}
  \tightlist
  \item
    \emph{``GRO structure file''}: output of
    \textbf{GROMACS structure configuration}
  \item
    \emph{``System topology''}: \texttt{output}
  \item
    \emph{``Generate detailed log''}: \texttt{Yes}
  \end{itemize}
% \end{enumerate}

\end{handson_box_colour}

\subsection*{Energy minimization}\label{energy-minimization}

After the solvation step, parameterization of the system is complete and preparatory simulations can be performed. The first of theses is energy minimization, which can be carried out using the
\textbf{GROMACS energy minimization} tool. The purpose of energy minimization is to relax the structure, removing any steric clashes or unusual geometry which would artificially raise the energy of the system.

\begin{handson_box_colour}{Energy minimization}

%\textbf{Hands-on: Energy minimization}\label{hands-on-task-description-5}

% \begin{enumerate}
% \def\labelenumi{\arabic{enumi}.}
% \tightlist
% \item
  \textbf{GROMACS energy minimization} with the following parameters:

  \begin{itemize}
  \tightlist
  \item
    \emph{``GRO structure file.''}: GRO output of
    \textbf{GROMACS solvation and adding ions}
  \item
    \emph{``Topology (TOP) file.''}: TOP output of
    \textbf{GROMACS solvation and adding ions}
  \item
    \emph{``Parameter input''}:
    \texttt{Use\ default\ (partially\ customisable)\ setting}

    \begin{itemize}
    \tightlist
    \item
      \emph{``Number of steps for the MD simulation''}: \texttt{50000}
    \item
      \emph{``EM tolerance''}: \texttt{1000.0}
    \end{itemize}
  \item
    \emph{``Generate detailed log''}: \texttt{Yes}
  \item
    Rename GRO output to \texttt{Minimized\ GRO\ file}
  \end{itemize}
% \end{enumerate}

\end{handson_box_colour}

The EM tolerance here refers to the maximum force which will be allowed in a minimized system. The simulation will be terminated when the maximum force is less than this value, or when 50000 steps have elapsed.

As an aside, 
we can use the `Extract energy components' tool to plot the convergence of the potential energy during the minimization.

\begin{handson_box_colour}{Checking EM convergence}
\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \textbf{Extract energy components with GROMACS} with the following parameters:

  \begin{itemize}
  \tightlist
  \item
    \emph{``EDR file''}: EDR output of
    \textbf{GROMACS energy minimization}
  \item
    \emph{``Terms to calculate''}: \texttt{Potential}
  \item
    \emph{``Output format''}:
    \texttt{Galaxy tabular}

  \end{itemize}
\item
  On the output tabular file, click on the 'Visualize this data' icon. This provides a range of visualization options. Select `Line chart (jqPlot)'.
\item
  In the visualization window which appears, click on `Select data.' Enter the following parameters:
  \begin{itemize}
  \tightlist
  \item
    \emph{``Provide a label''}: \texttt{Energy potential}
    \emph{``Values for x-axis''}: \texttt{Column: 1}
  \item
    \emph{``Values for y-axis''}: \texttt{Column: 2}
  \end{itemize}
\end{enumerate}

\end{handson_box_colour}

The resulting plot should resemble Figure \ref{fig:empot}. The system first drops rapidly in energy, before slowly converging on the minimized state.

\begin{figure}[ht!]
  %\includegraphics[width=0.4\textwidth]{em_potential}
  \caption{\csentence{Energy potential}
       during the EM simulation.}
  \label{fig:empot}
\end{figure}

\subsection*{Equilibration}\label{equilibration}

At this point equilibration of the solvent around the solute (i.e. the protein) is necessary. This is performed in two stages: equilibration under an NVT (or isothermal-isochoric) ensemble, followed by an NPT (or isothermal-isobaric) ensemble. Use of the NVT ensemble entails maintaining constant number of particles, volume and temperature, while the NPT ensemble maintains constant number of particles, pressure and temperature.

For equilibration, the protein must be held in place while the solvent is allowed to move freely around it. This is achieved using the position restraint file (ITP) we created in system setup. When we specify this restraint, protein movement is not forbidden, but is energetically penalized.

\begin{handson_box_colour}{NVT
equilibration}

%\textbf{Hands-on: NVT equilibration}\label{hands-on-nvt-equilibration}

% \begin{enumerate}
% \def\labelenumi{\arabic{enumi}.}
% \tightlist
% \item
  \textbf{GROMACS simulation} with the following parameters:

  \begin{itemize}
  \tightlist
  \item
    \emph{``GRO structure file''}: \texttt{Minimized\ GRO\ file} (from
    energy minimization step)
  \item
    \emph{``Topology (TOP) file''}: TOP file produced by solvation step.
  \item
    In \emph{``Inputs''}:

    \begin{itemize}
    \tightlist
    \item
      \emph{``Position restraint (ITP) file''}: ITP file produced by
      initial setup step.
    \end{itemize}
  \item
    In \emph{``Outputs''}:

    \begin{itemize}
    \tightlist
    \item
      \emph{``Trajectory output''}:
      \texttt{Return\ .xtc\ file\ (reduced\ precision)}
    \item
      \emph{``Structure output''}: \texttt{Return\ .gro\ file}
    \item
      \emph{``Produce a checkpoint (CPT) file''}:
      \texttt{Produce\ CPT\ output}
    \item
      \emph{``Produce an energy (EDR) file''}:
      \texttt{Produce\ EDR\ output}
    \end{itemize}
  \item
    In \emph{``Settings''}:

    \begin{itemize}
    \tightlist
    \item
      \emph{``Parameter input''}:
      \texttt{Use\ default\ (partially\ customisable)\ setting}

      \begin{itemize}
      \tightlist
      \item
        \emph{``Bond constraints (constraints)''}:
        \texttt{All\ bonds\ (all-bonds).}
      \item
        \emph{``Temperature /K''}: \texttt{300}
      \item
        \emph{``Step length in ps''}: \texttt{0.0002}
      \item
        \emph{``Number of steps that elapse between saving data points
        (velocities, forces, energies)''}: \texttt{1000}
      \item
        \emph{``Number of steps for the simulation''}: \texttt{50000}
      \end{itemize}
    \end{itemize}
  \item
    \emph{``Generate detailed log''}: \texttt{Yes}
  \end{itemize}
% \end{enumerate}

\end{handson_box_colour}

Once the NVT equilibration is complete, it is worth using the \textbf{Extract energy components} tool again to check whether the system temperature has converged on 300 K. This can be done as described for energy minimization, this time specifying \texttt{Temperature} under \emph{Terms to calculate} rather \texttt{Potential}. The plot should show the temperature reaching 300 K and remaining there, albeit with some fluctuation.

Having stabilized the temperature of the system with NVT equilibration,
we also need to stabilize the pressure of the system. We therefore
equilibrate again using the NPT (constant number of particles, pressure,
temperature) ensemble.

Note that we can continue where the last simulation left off (with new
parameters) by using the checkpoint (CPT) file saved at the end of the
NVT simulation.

\begin{handson_box_colour}{NPT
equilibration}

%\textbf{Hands-on: NPT equilibration}\label{hands-on-npt-equilibration}

% \begin{enumerate}
% \def\labelenumi{\arabic{enumi}.}
% \tightlist
% \item
  \textbf{GROMACS simulation} with the following parameters:

  \begin{itemize}
  \tightlist
  \item
    \emph{``GRO structure file''}: GRO output of \textbf{GROMACS
    simulation} (NVT equilibration)
  \item
    \emph{``Topology (TOP) file''}: TOP file produced by solvation step.
  \item
    In \emph{``Inputs''}:

    \begin{itemize}
    \tightlist
    \item
      \emph{``Checkpoint (CPT) file''}: Output of \textbf{GROMACS
      simulation} (NVT equilibration))
    \item
      \emph{``Position restraint (ITP) file''}: ITP file produced by
      initial setup step.
    \end{itemize}
  \item
    In \emph{``Outputs''}:

    \begin{itemize}
    \tightlist
    \item
      \emph{``Trajectory output''}:
      \texttt{Return\ .xtc\ file\ (reduced\ precision)}
    \item
      \emph{``Structure output''}: \texttt{Return\ .gro\ file}
    \item
      \emph{``Produce a checkpoint (CPT) file''}:
      \texttt{Produce\ CPT\ output}
    \item
      \emph{``Produce an energy (EDR) file''}:
      \texttt{Produce\ EDR\ output}
    \end{itemize}
  \item
    In \emph{``Settings''}:

    \begin{itemize}
    \tightlist
    \item
      \emph{``Ensemble''}: \texttt{Isothermal-isobaric\ ensemble\ (NPT)}
    \item
      \emph{``Parameter input''}:
      \texttt{Use\ default\ (partially\ customisable)\ setting}

      \begin{itemize}
      \tightlist
      \item
        \emph{``Bond constraints (constraints)''}:
        \texttt{All\ bonds\ (all-bonds).}
      \item
        \emph{``Temperature /K''}: \texttt{300}
      \item
        \emph{``Step length in ps''}: \texttt{0.002}
      \item
        \emph{``Number of steps that elapse between saving data points
        (velocities, forces, energies)''}: \texttt{1000}
      \item
        \emph{``Number of steps for the simulation''}: \texttt{50000}
      \end{itemize}
    \end{itemize}
  \item
    \emph{``Generate detailed log''}: \texttt{Yes}
  \end{itemize}
% \end{enumerate}

\end{handson_box_colour}

After the NPT equilibration is complete, \textbf{Extract energy components} can be used again to view the pressure of the system. This is done as described for energy minimization, specifying \texttt{Pressure} under \emph{Terms to calculate}. The plot should show convergence on 1 bar and remaining there, although some fluctuation is expected.

\subsection*{Production simulation}\label{production-simulation}

We can now remove the restraints and continue with the production simulation. The simulation will run for 1 million steps, with a step size of 1 fs, so will have a total length of 1 ns. This is rather short compared to the state-of-the-art, but sufficient for the purposes of a tutorial. For longer-scale simulations, the tool can be used multiple times (with the checkpoint file) to continue the existing simulation.

\begin{handson_box_colour}{Main simulation}

%\hypertarget{hands-on-task-description-6}{%
%\textbf{Hands-on: Task description}\label{hands-on-task-description-6}}

% \begin{enumerate}
% \def\labelenumi{\arabic{enumi}.}
% \tightlist
% \item
  \textbf{GROMACS simulation} with the following parameters:

  \begin{itemize}
  \tightlist
  \item
    \emph{``GRO structure file''}: Output of \textbf{GROMACS simulation}
    (NPT equilibration)
  \item
    \emph{``Topology (TOP) file''}: Output of the solvation step
  \item
    In \emph{``Inputs''}:

    \begin{itemize}
    \tightlist
    \item
      \emph{``Checkpoint (CPT) file''}: Output of \textbf{GROMACS
      simulation} (NPT simulation))
    \end{itemize}
  \item
    In \emph{``Outputs''}:

    \begin{itemize}
    \tightlist
    \item
      \emph{``Trajectory output''}:
      \texttt{Return\ .xtc\ file\ (reduced\ precision)}
    \item
      \emph{``Structure output''}: \texttt{Return\ .gro\ file}
    \item
      \emph{``Produce a checkpoint (CPT) file''}:
      \texttt{Produce\ CPT\ output}
    \end{itemize}
  \item
    In \emph{``Settings''}:

    \begin{itemize}
    \tightlist
    \item
      \emph{``Ensemble''}: \texttt{Isothermal-isobaric\ ensemble\ (NPT)}
    \item
      \emph{``Parameter input''}:
      \texttt{Use\ default\ (partially\ customisable)\ setting}

      \begin{itemize}
      \tightlist
      \item
        \emph{``Temperature /K''}: \texttt{300}
      \item
        \emph{``Step length in ps''}: \texttt{0.001}
      \item
        \emph{``Number of steps that elapse between saving data points
        (velocities, forces, energies)''}: \texttt{1000}
      \item
        \emph{``Number of steps for the simulation''}: \texttt{1000000}
      \end{itemize}
    \end{itemize}
  \item
    \emph{``Generate detailed log''}: \texttt{Yes}
  \end{itemize}
% \end{enumerate}

\end{handson_box_colour}


\hypertarget{analysis}{%
\section*{Methods: Analysis}\label{analysis}}

An analysis of the GROMACS simulation outputs (structure and trajectory file) will be carried out using Galaxy tools developed for computational chemistry~\cite{senapathi_biomolecular_2019} based on popular analysis software, such as MDAnalysis~\cite{michaudagrawal_mdanalysis_2011}, MDTraj~\cite{mcgibbon_mdtraj_2015}, and  Bio3D~\cite{skjaerven_integrating_2014}. These tools output both tabular files as well as a variety of attractive plots.



\hypertarget{create-pdb-file-needed-by-most-analysis-tools}{%
\subsection*{Convert coordinate and trajectory formats}\label{create-pdb-file-needed-by-most-analysis-tools}}

Before beginning a detailed analysis, the structure and trajectory files generated previously need to be converted into different formats. First, convert the structural coordinates of the system in GRO format into PDB format. This PDB file will be used by most analysis tools as a starting structure. This tool can also be used to carry out initial setup (as discussed in the simulation methods section) for GROMACS simulations and convert from PDB to GRO format. Next, convert the trajectory from XTC to DCD format, as a number of tools (particularly those based on Bio3D) only accept trajectories in DCD format. This tool can also be used to interconvert between several other trajectory formats.

\begin{handson_box_colour}{Convert coordinate and trajectory formats}
\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
% \tightlist
 \item
  \textbf{GROMACS structure configuration} with the following
  parameters:

  \begin{itemize}
  \tightlist
  \item
    \emph{``Output format''}: \texttt{PDB\ file}
  \item
    \emph{``Configure box?''}: \texttt{No}
  \end{itemize}
% \end{enumerate}
%\hypertarget{hands-on-task-description-8}{%
%\subsubsection{Hands-on: Task
%description}\label{hands-on-task-description-8}}

% \begin{enumerate}
% \def\labelenumi{\arabic{enumi}.}
% \tightlist
 \item
  \textbf{MDTraj file converter} with the following parameters:

  \begin{itemize}
  \tightlist
  \item
    \emph{``Output format''}: \texttt{DCD\ file}
  \end{itemize}
\end{enumerate}
\end{handson_box_colour}

%\hypertarget{convert-trajectory-to-dcd-format}{%
%\subsection*{Convert trajectory to DCD
%format}\label{convert-trajectory-to-dcd-format}}



\hypertarget{rmsd-analysis}{%
\subsection*{RMSD analysis}\label{rmsd-analysis}}


The Root Mean Square Deviation (RMSD) and Root Mean Square Fluctuation (RMSF) are calculated to check the stability and conformation of the protein and ligand through the course of the simulation. 
RMSD is a standard measure of structural distance between coordinate
sets that measures the average distance between a group of atoms. The
RMSD of the C$\alpha$ atoms of the protein backbone is calculated here and
is a measure of how much the protein conformation has changed between different time points in the trajectory. Note that for more complex systems, you may need to consider a more focused selection.

For the RMSD analysis of the ligand, the `Select domains' parameter of the tool can for convenience be set to `Ligand'; however, this automatic selection sometimes fails. The other alternative, which we apply here, is to specify the `Residue ID' in the textbox provided. In this example the ligand's Residue ID is `G5E'. The output is the requested RMSD data as a time series, the RMSD plotted as a time series and as a histogram (for example, see Figure \ref{fig:rmsdprotein} in the results section).

\begin{handson_box_colour}{RMSD Analysis: protein}
%\hypertarget{hands-on-task-description-9}{%
%\subsubsection*{Hands-on: Task description}\label{hands-on-task-description-9}}

% \begin{enumerate}
% \def\labelenumi{\arabic{enumi}.}
% \tightlist
% \item
  \textbf{RMSD Analysis} with the following parameters:

  \begin{itemize}
  \tightlist
    \item
    \emph{``DCD trajectory input''}: output of
    \textbf{MDTraj file converter}
  \item
    \emph{``PDB input''}: output of \textbf{GROMACS
    structure configuration}
  \item
    \emph{``Select domains''}: \texttt{C-alpha}
  \end{itemize}

% \end{enumerate}
\end{handson_box_colour}

%\hypertarget{hands-on-task-description-10}{%
%\subsubsection*{Hands-on: Task description}\label{hands-on-task-description-10}}
% \begin{handson_box_colour}{RMSD Analysis: ligand}
% % \begin{enumerate}
% % \def\labelenumi{\arabic{enumi}.}
% % \tightlist
% % \item
%   \textbf{RMSD Analysis} with the following parameters:

%   \begin{itemize}
%   \tightlist
%   \item
%     \emph{``DCD trajectory input''}: \texttt{output} (output of
%     \textbf{MDTraj file converter} )
%   \item
%     \emph{``PDB input''}: \texttt{output} (output of \textbf{GROMACS
%     structure configuration} )
%   \item
%     \emph{``Select domains''}: \texttt{Ligand}
%   \end{itemize}

% % \end{enumerate}
% \end{handson_box_colour}

%\hypertarget{hands-on-task-description-11}{%
%\subsubsection*{Hands-on: Task
%description}\label{hands-on-task-description-11}}
\begin{handson_box_colour}{RMSD Analysis: ligand using Residue ID}
% \begin{enumerate}
% \def\labelenumi{\arabic{enumi}.}
% \tightlist
% \item
  \textbf{RMSD Analysis} with the following parameters:

  \begin{itemize}
  \tightlist
  \item
    \emph{``DCD trajectory input''}: output of
    \textbf{MDTraj file converter}
  \item
    \emph{``PDB input''}:
    output of \textbf{GROMACS
    structure configuration}
  \item
    \emph{``Select domains''}: \texttt{Residue\ ID}

    \begin{itemize}
    \tightlist
    \item
      \emph{``Residue ID''}: \texttt{G5E}
    \end{itemize}
  \end{itemize}

% \end{enumerate}


\end{handson_box_colour}



\hypertarget{rmsf-analysis}{%
\subsection*{RMSF analysis}\label{rmsf-analysis}}

The Root Mean Square Fluctuation (RMSF) is valuable to consider, as it represents the deviation at a reference position over time. The fluctuation in space of particular amino acids in the protein are considered. The C$\alpha$ of the protein, designated by \texttt{C-alpha}, is a good selection to understand the change in protein structure. Depending on the system these fluctuations can be correlated to experimental techniques including Nuclear Magnetic Resonance (NMR) and M\"{o}ssbauer spectroscopy~\cite{berjanskii_nmr_2006,kuzmanic_determination_2010}. The output from the tools is the requested RMSF data and the RMSF plotted as a time series (for example, see Figure \ref{fig:rmsf} in the results section).

\begin{handson_box_colour}{RMSF Analysis}


%\hypertarget{hands-on-task-description-12}{%
%\subsubsection{Hands-on: Task
%description}\label{hands-on-task-description-12}}

% \begin{enumerate}
% \def\labelenumi{\arabic{enumi}.}
% \tightlist
% \item
  \textbf{RMSF Analysis} with the following parameters:

  \begin{itemize}
  \tightlist
  \item
    \emph{``DCD trajectory input''}: output of
    \textbf{MDTraj file converter}
  \item
    \emph{``PDB input''}:
    output of \textbf{GROMACS
    structure configuration}
  \item
    \emph{``Select domains''}: \texttt{C-alpha}
  \end{itemize}

% \end{enumerate}


\end{handson_box_colour}


\hypertarget{pca-analysis}{%
\subsection*{PCA}\label{pca-analysis}}

Principal component analysis (PCA) converts a set of correlated
observations (movement of selected atoms in protein) to a set of principal
components (PCs) which are linearly independent (or uncorrelated). Here several related tools are used. 
The PCA tool calculates the PCA in order to determine the relationship between statistically meaningful conformations (major global motions) sampled during the trajectory. The C$\alpha$ carbons of the protein backbone are again a good selection for this purpose.  Outputs include the PCA raw data and figures of the relevant principal components (PCs) as well as an eigenvalue rank plot (see Figure \ref{fig:pca}) which is used to visualize the proportion of variance due to each principal component (remembering that the PCs are ranked eigenvectors based on the variance). 
Having discovered the principal components usually these are visualized. The PCA visualization tool will create trajectories of specific principal components which can be viewed in a molecular viewer such as VMD~\cite{hump_vmd_1996} or NGL viewer~\cite{Rose2018ngl}. We also consider the PCA cosine content which when close to 1 indicates that the simulation is not converged and a longer simulation is needed. For values below 0.7, no statement can be made about convergence or lack thereof. 


\begin{handson_box_colour}{PCA with BIO3D}

%\hypertarget{hands-on-task-description-13}{%
%\subsubsection{Hands-on: Task
%description}\label{hands-on-task-description-13}}

% \begin{enumerate}
% \def\labelenumi{\arabic{enumi}.}
% \tightlist
% \item
  \textbf{PCA} with the following parameters:

  \begin{itemize}
  \tightlist
  \item
    \emph{``DCD trajectory input''}: output of
    \textbf{MDTraj file converter}
  \item
    \emph{``PDB input''}: output of \textbf{GROMACS
    structure configuration}
  \item
    \emph{``Select domains''}: \texttt{C-alpha}
  \end{itemize}

% \end{enumerate}
\end{handson_box_colour}

\begin{handson_box_colour}{PCA visualization}
%\hypertarget{hands-on-task-description-15}{%
%\subsubsection{Hands-on: Task
%description}\label{hands-on-task-description-15}}

% \begin{enumerate}
% \def\labelenumi{\arabic{enumi}.}
% \tightlist
% \item
  \textbf{PCA visualization} with the following parameters:

  \begin{itemize}
  \tightlist
  \item
    \emph{``DCD trajectory input''}: output of
    \textbf{MDTraj file converter}
  \item
    \emph{``PDB input''}: output of \textbf{GROMACS
    structure configuration}
  \item
    \emph{``Select domains''}: \texttt{C-alpha}
  \end{itemize}

% \end{enumerate}


\end{handson_box_colour}
%\hypertarget{hands-on-task-description-14}{%
%\subsubsection{Hands-on: Task
%description}\label{hands-on-task-description-14}}
\begin{handson_box_colour}{Cosine content calculation}
% \begin{enumerate}
% \def\labelenumi{\arabic{enumi}.}
% \tightlist
% \item
  \textbf{Cosine Content} with the following parameters:

  \begin{itemize}
  \tightlist
  \item
    \emph{``DCD/XTC trajectory input''}: output of
    \textbf{MDTraj file converter}
  \item
    \emph{``PDB/GRO input''}: output of \textbf{GROMACS
    structure configuration}
  \end{itemize}


% \end{enumerate}

\end{handson_box_colour}




\hypertarget{hydrogen-bond-analysis}{%
\subsection*{Hydrogen bond analysis}\label{hydrogen-bond-analysis}}

Hydrogen bonding interactions contribute to binding and are worth investigating, in particular persistent hydrogen bonds. All possible hydrogen bonding interactions between the two selected regions, here the protein and the ligand, are investigated over time using the VMD hydrogen bond analysis tool included in Galaxy. Hydrogen bonds are identified and in the output the total number of hydrogen bonds and  occupancy over time is returned.

\begin{handson_box_colour}{Hydrogen bond analyis}
%\hypertarget{hands-on-task-description-16}{%
%\subsubsection{Hands-on: Task
%description}\label{hands-on-task-description-16}}

% \begin{enumerate}
% \def\labelenumi{\arabic{enumi}.}
% \tightlist
% \item
  \textbf{Hydrogen Bond Analysis using VMD} with the following
  parameters:

  \begin{itemize}
  \tightlist
  \item
    \emph{``DCD/XTC trajectory input''}: output of
    \textbf{MDTraj file converter}
  \item
    \emph{``PDB/GRO input''}: output of \textbf{GROMACS
    structure configuration}
  \item
    \emph{``Selection 1''}: \texttt{protein}
  \item
    \emph{``Selection 2''}: \texttt{resname\ G5E}
  \end{itemize}


% \end{enumerate}

\end{handson_box_colour}




\hypertarget{resultsanddiscussion}{%
\section*{Results and Discussion}\label{resultsanddiscussion}}
After the completion of the simulation, the following questions arise: 1) is the simulation converged enough, and 2) what interesting molecular properties are observed. The timescale of motions of interest are in the picosecond to nanosecond range; these are motions such as domain vibration, hydrogen bond breaking, translation diffusion and side chain fluctuations. To observe meaningful conformational transitions of the protein $\mu$s sampling would be needed, but this is not the purpose here. 

The PCA cosine content of the dominant motion related to PC1 is 0.93, indicating that the simulation is not fully converged. This is expected due to the short simulation length. For production level simulations, it is the norm to extend simulations to hundreds of nanoseconds in length, if not microseconds. As this tutorial is designed to be carried out on public webservers, we limit simulations to 1 ns, as we cannot provide a large amount of computational resources for training purposes. 

\subsection*{RMSD protein}
The RMSD time series for the protein shows a thermally stable and equilibrated structure that plateaus at 1.0{\AA} with an average RMSD between 0.8{\AA} and 1.0{\AA}. There are no large conformational changes during the simulation. The RMSD histogram confirms this, see Figure \ref{fig:rmsdprotein}. Note these graphs are automatically created by Galaxy as part of the tool's outputs.

\begin{figure}[ht!]
  %\includegraphics[width=0.4\textwidth]{htmd_analysis_rmsd1_merge}
  \caption{\csentence{RMSD for protein.}
      RMSD time series and histogram for the protein.}
  \label{fig:rmsdprotein}
\end{figure}
%%\includegraphics{images/htmd_analysis_rmsd1_series.png}
%%\includegraphics{images/htmd_analysis_rmsd1_histo.png}

\subsection*{RMSD ligand}
Calculating the RMSD of the ligand is necessary to check if it is stable in the active site and to identify possible binding modes. If the ligand is not stable, there will be large fluctuations in the RMSD.

In our case the ligand is stable with a single binding mode. The RMSD fluctuates around 0.3{\AA}, with a slight fluctuation near the end of the simulation. This is more clearly seen in the histogram, see Figure \ref{fig:rmsdligand}. The conformation seen during simulation is very similar to that in the crystal structure and the ligand is stable in the active site.

\begin{figure}[ht!]
  %\includegraphics[width=0.4\textwidth]{htmd_analysis_rmsd2_merge}
  \caption{\csentence{RMSD for the ligand.}
      RMSD time series and histogram for the ligand.}
  \label{fig:rmsdligand}
\end{figure}
%%\includegraphics{images/htmd_analysis_rmsd2_series.png}
%%\includegraphics{images/htmd_analysis_rmsd2_histo.png}
%%\includegraphics{images/htmd_analysis_bindingposes.png}


\subsection*{RMSF}
When considering the RMSF (Figure \ref{fig:rmsf}), fluctuations greater than 1.0{\AA} are of interest; for example see the fluctuations near residue positions 50, 110 and 160.  Inspecting the structure with molecular visualization software such as VMD, these can be seen to correspond to flexible loop regions on the protein surface. In addition, very large fluctuations are seen for the C-terminus; this is common and no investigation is needed.

Note that the first few residues of this protein are missing in the PDB, and therefore residue position 0 in the RMSF corresponds to position 17 in the Hsp90 FASTA primary sequence. This is a fairly common problem that can occur with molecular modeling of proteins, where there may be missing residues at the beginning or within the sequence.

% possibly RMSF fig but not really needed
\begin{figure}[ht!]
  %\includegraphics[width=0.4\textwidth]{htmd_analysis_rmsf}
  \caption{\csentence{RMSF for the protein.}
      RMSF(\AA) vs the residue position. Large fluctuations occur at various positions, which correspond to flexible loop regions on the surface of the protein.}
\label{fig:rmsf}
\end{figure}
%%\includegraphics{images/htmd_analysis_rmsf.png}

\subsection*{PCA}

The first three principal components are responsible for 32.8\% of the total variance, as seen in the eigenvalue rank plot (Figure \ref{fig:pca}). The first principal component (PC1) accounts for 15.4\% of the variance (see PC1 vs PC2 and eigenvalue rank plots in Figure \ref{fig:pca}). Visualization of PC1 using VMD shows a rocking motion and wagging of the C-terminus.


\begin{figure}[ht!]
  %\includegraphics[width=0.4\textwidth]{htmd_analysis_pca}
  \caption{\csentence{Principal Component Analysis.}
      PCA results which include graphs of PC2 vs PC1, PC2 vs PC3, PC3 vs PC1  colored from blue to red in order of time, and an eigenvalue rank plot. In the eigenvalue plot the cumulative variance is labeled for each data point.}
 \label{fig:pca}
 \end{figure}
%%\includegraphics{images/htmd_analysis_pca.png}
%%\includegraphics{images/htmd_analysis_pc1_rmsf.png}

\subsection*{Hydrogen bonding}
The active site of this protein is quite hydrophobic, yet multiple hydrogen bonds were identified. The hydrogen bond between aspartate-93 and the ligand (as identified in the crystal structure) was found to be persistent, meeting the hydrogen bond criteria for 89.22\% of the simulation. A hydrogen bond between the ligand and the carbonyl group of glycine-97 was found to have a 15.27\% occupancy. Hydrogen bonding interactions with threonine-184, asparagine-51 and lysine-58 were also observed but these are not persistent and only present for a minority of the simulation. These values can be accessed from the 'Percentage occupancy of the H-bond' output of the hydrogen bond analysis tool. 

\hypertarget{optional-automating-high-throughput-calculations}{%
\section*{High throughput workflows}\label{optional-automating-high-throughput-calculations}}

Up until this step, Galaxy tools have been applied sequentially to datasets. This is useful to gain an understanding of the steps involved, but becomes tedious if the workflow needs to be run on multiple protein-ligand systems. Fortunately, Galaxy allows entire workflows to be executed with a single mouse-click, enabling straightforward high-throughput analyses.

We will demonstrate the high-throughput capabilities of Galaxy by running the workflow detailed so far on a further three ligands.

\begin{handson_box_colour}{High-throughput MD}
%\textbf{Hands-on: Data upload}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Create a new history for running the high-throughput workflow and name it `Hsp90 HTMD simulation'

\item
  Upload the SD-file containing the new ligand structures from Zenodo (LINK...) and rename it `Ligands (SDF)'
\item
  Import the simulation workflow from the European~\cite{eu_htmd_simulation_workflow} or the South African Galaxy server~\cite{za_htmd_simulation_workflow}.
\item
  Run the imported workflow with the following parameters:

  \begin{itemize}
  \tightlist
  \item
    \emph{``SDF file with (docked) ligands''}: `Ligands (SDF)' file.
  \end{itemize}
\item
  Import the analysis workflow from the European~\cite{eu_htmd_analysis_workflow} or the South African Galaxy server~\cite{za_htmd_analysis_workflow} (also available through Zenodo).
\item
  Run the imported workflow with the following parameters:
  \begin{itemize}
  \tightlist
  \item
    \emph{``Send results to a new history''}: `Yes'
  \item
    \emph{``History name''}: `Hsp90 HTMD analysis'
  \item
    \emph{``GRO input''}: Collection of GRO files produced by simulation workflow
  \item
    \emph{``XTC input''}: Collection of XTC files produced by simulation workflow
  \end{itemize}
\end{enumerate}
\end{handson_box_colour}

This process runs the entire simulation and analysis procedure described so far on the new set of ligands. It uses Galaxy's collection~\cite{gtn_collections} feature to organize the data; each item in the history is a collection (essentially a directory containing multiple individual datasets) containing one file corresponding to each of the input ligands.

Note that the SD-file needs to contain ligands with the correct 3D coordinates for MD simulation. The easiest way to obtain these is using a molecular docking tool such as Autodock Vina~\cite{Trott2009} or rDock~\cite{Ruiz2014}; tutorials and workflows are available for both of these from the Galaxy Training Network. As an example, the history in which the SD-file used in the HTMD workflow is generated (using AutoDock Vina) is provided~\cite{eu_6hhr}.

\subsection*{Further information}

Apart from manual setups or collections, there are several other alternatives which are helpful in scaling up workflows. Galaxy supports and provides training material for converting histories to workflows~\cite{gtn_toworkflow}, using multiple histories~\cite{gtn_multiple}, and the Galaxy Application Programming Interface (API)~\cite{gtn_api}. For beginners and users who prefer a visual interface, automation can be done using multiple histories and collections with the standard Galaxy user interface. 

If you are able to write small scripts, you can automate everything you have learned here with the Galaxy API. This allows you to interact with the server to automate repetitive tasks and create more complex workflows (which may have repetition or branching). The simplest way to access the API is through the Python library BioBlend~\cite{sloggett_bioblend}. An example Python script, which uses BioBlend to run the GROMACS simulation workflow for each of a list of ligands, is given in the hands-on box below. 
\begin{handson_box_colour}{BioBlend script}
\begin{minted}[linenos=false, breaklines, breakafter=d, fontsize=\small]{python} 
from bioblend import galaxy

# Server and account details
API_KEY = 'YOUR USEGALAXY.EU API KEY'
gi = galaxy.GalaxyInstance(key=API_KEY,
    url='https://usegalaxy.eu/')

# ID for GROMACS workflow
workflow_id = 'adc6d049e9283789' 

# Dataset IDs for ligands to dock
ligands = {
# ligand_name: dataset ID,
'lig1': '11ac94870d0bb33a79c5fa18b0fd3b4c',
# ...
}

# Loop over ligands, invoking workflow
for name, _id in ligands.items():
    inv = gi.workflows.invoke_workflow(
        workflow_id,
        inputs={
            '1': {'src': 'hda', 'id': _id}
        },
        history_name=f'HTMD run on {name}'
    )
\end{minted}
\end{handson_box_colour}


\hypertarget{conclusion}{%
\section*{Conclusion}\label{conclusion}}

This tutorial provides a guide on how to study protein-ligand interaction using molecular dynamics in Galaxy. Performing such analyses in Galaxy makes it straightforward to set up, schedule and run workflows, removing much of the difficulty from MD simulation. Thus, the technical barrier to performing high-throughput studies is greatly reduced. Results are structured in the form of Galaxy histories or collections, and include ready-plotted diagrams, which ensure data can be easily understood and reproduced if necessary. Apart from streamlining the process for existing MD users, this tutorial should also prove useful as a pedagogical guide for educating students or newcomers to the field.

After completing the tutorial, the user will be familiar at a basic level with a range of MD analysis techniques, and understand the steps required for a typical MD simulation. Thus, they will be equipped to apply these tools to their own problems.



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                                          %%
%% Backmatter begins here                   %%
%%                                          %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{backmatter}

\section*{Competing interests}
  The authors declare that they have no competing interests.

\section*{Author's contributions}
All authors contributed to writing Galaxy tools, creating workflows, writing training material, and writing the paper.

\section*{Acknowledgements}
We thank Bérénice Batut for helpful comments and discussions. In addition, we thank the entire Galaxy Training Network, as well as the European Galaxy and ilifu teams, for their support.

The European Galaxy server, which was used for the calculations described, is in part funded by Collaborative Research Centre 992 Medical Epigenetics (DFG grant SFB 992/1 2012) and German Federal Ministry of Education and Research (BMBF grants 031 A538A/A538C RBC, 031L0101B/031L0101C de.NBI-epi, 031L0106 de.STAIR (de.NBI)).

\section*{Funding}
This work was supported by funding from the following organizations: S.A.B. was funded by the European Open Science Cloud (EOSC-Life) (Grant No. 824087);  T.S. and C.B.B. were funded by the University of Cape Town’s Research Committee (URC) and by the National Research Foundation of South Africa (Grant Numbers 115215 and 116362); and B.A.G was funded by the German Research Foundation for the Collaborative Research Center 992 Medical Epigenetics [SFB 992/1 2012 and SFB 992/2 2016].

\section*{Data and material availability}
  Data and materials are available on GitHub:

  \begin{itemize}
  \item European Galaxy server (\url{https://cheminformatics.usegalaxy.eu}) 
  \item Galaxy Computational Chemistry South Africa server (\url{https://galaxy-compchem.ilifu.ac.za})
  \item Galaxy Training Network website (\url{https://training.galaxyproject.org/topics/computational-chemistry/tutorials/htmd-analysis/tutorial.html})
  \item Supplementary Material, including workflows and data used (\url{https://github.com/galaxycomputationalchemistry/htmd-paper-sm})  TODO workflow or any other materials\ldots
\end{itemize}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                  The Bibliography                       %%
%%                                                         %%
%%  Bmc_mathpys.bst  will be used to                       %%
%%  create a .BBL file for submission.                     %%
%%  After submission of the .TEX file,                     %%
%%  you will be prompted to submit your .BBL file.         %%
%%                                                         %%
%%                                                         %%
%%  Note that the displayed Bibliography will not          %%
%%  necessarily be rendered by Latex exactly as specified  %%
%%  in the online Instructions for Authors.                %%
%%                                                         %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% if your bibliography is in bibtex format, use those commands:
\bibliographystyle{bmc-mathphys} % Style BST file (bmc-mathphys, vancouver, spbasic).
\bibliography{bmc_article}      % Bibliography file (usually '*.bib' )
% for author-year bibliography (bmc-mathphys or spbasic)
% a) write to bib file (bmc-mathphys only)
% @settings{label, options="nameyear"}
% b) uncomment next line
%\nocite{label}

% or include bibliography directly:
% \begin{thebibliography}
% \bibitem{b1}
% \end{thebibliography}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                               %%
%% Figures                       %%
%%                               %%
%% NB: this is for captions and  %%
%% Titles. All graphics must be  %%
%% submitted separately and NOT  %%
%% included in the Tex document  %%
%%                               %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%
%% Do not use \listoffigures as most will included as separate files




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                               %%
%% Additional Files              %%
%%                               %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% \section*{Additional Files}
%   \subsection*{Additional file 1 --- Sample additional file title}
%     Additional file descriptions text (including details of how to
%     view the file, if it is in a non-standard format or the file extension).  This might
%     refer to a multi-page table or a figure.

%   \subsection*{Additional file 2 --- Sample additional file title}
%     Additional file descriptions text.


\end{backmatter}
\end{document}
